<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <title>Gest√£o de Manuten√ß√µes</title>
  <link rel="icon" href="favicon.ico" type="image/x-icon">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background-image: url("avac.jpg");}
    h2 { 
      margin-top: 0; 
      color: red;
      font-family: Candara ;
    }
    .tabs { display: flex; margin-bottom: 15px; flex-wrap: wrap; }
    .tab { flex: 1; padding: 10px; text-align: center; background: #ddd; cursor: pointer; border-radius: 15px 15px 0 10px; }
    .tab.active { background: lightblue; font-weight: bold; border-bottom: 2px solid #fff; }
    .content { display: none; background: #fff; padding: 15px; border-radius: 0 5px 5px 5px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
    .content.active { display: block; background: #FFFAFA;}
    form label { display: block; margin: 8px 0 4px; }
    form input, form select, form textarea { width: 100%; padding: 6px;}
    button { margin: 8px 5px 0 0; padding: 6px 12px; cursor: pointer; }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    td { border: 1px solid #aaa; padding: 6px; text-align: left; }
    tr.selected { background: #ffe4b5; }
    th {
      border: 1px solid #aaa;
      padding: 6px;
      text-align: center;
      background-color: grey;
    }
    .total { margin-top: 8px; font-weight: bold; text-align: right;}
    header {
      text-align: right;
    }
  </style>
</head>
<body>
  <header>
    <img src="C:\Users\i3Bs\OneDrive\Aplica√ß√µes\Registo_Manuten√ß√µes\3bs.jpeg" style="width: 125px; height: 100px;">
  </header>
  <h1>Registos</h1>

  <!-- Separadores -->
  <div class="tabs">
    <button class="tab active" data-tab="novo">üõ†Ô∏è Novo</button>
    <button class="tab" data-tab="stock">üì¶ Stock</button>
    <button class="tab" data-tab="filtros">üîç Filtros</button>
    <button class="tab" data-tab="notas">üìù Notas</button>
    <button class="tab" data-tab="excel">üõ†Ô∏è Importar Excel</button>
  </div>

  <!-- Novo Registo -->
  <div class="content active" id="novo">
    <h2>Novo Registo</h2>
    <form id="formNovo">
      <input type="hidden" id="indiceEditarNovo">
      <label>Empresa: <input type="text" id="empresa" required></label>
      <label>Edif√≠cio: <input type="text" id="edificio" required></label>
      <label>Tipo: <input type="text" id="tipo" required></label>
      <label>Data: <input type="date" id="dataNovo" required></label>
      <label>Observa√ß√µes: <input type="text" id="obs"></label>
      <button type="submit"style="background-color: green;">Guardar</button>
      <button type="button" onclick="resetForm('formNovo')"style="background-color: red;">Cancelar</button>
      <button type="button" onclick="abrirLink2()">Impressoras</button>
      <button type="button" onclick="abrirLink3()">Leituras</button>
      <button type="button" onclick="abrirLink()">Manuten√ß√£o Preventiva</button>
      <button onclick="exportarExcel()" style="color: blue;">Exportar para Excel</button>    
    </form>
    <table id="tabelaNovo"><thead><tr><th>Empresa</th><th>Edif√≠cio</th><th>Tipo</th><th>Data</th><th>Obs</th></tr></thead><tbody></tbody></table>
    <div id="totalNovo" class="total"></div>
  </div>

  <!-- Stock -->
  <div class="content" id="stock">
    <h2>Stock Material</h2>
    <form id="formStock">
      <input type="hidden" id="indiceEditarStock">
      <label>Data: <input type="date" id="dataStock" required></label>
      <label>Tipo: <input type="text" id="tipoStock" required></label>
      <label>Produto: <input type="text" id="produto" required></label>
      <label>Quantidade: <input type="number" id="quantidade" required></label>
      <button type="submit"style="background-color: green;">Guardar</button>
      <button type="button" onclick="resetForm('formStock')"style="background-color: red;">Cancelar</button>
      <button type="button" onclick="openLink()">Stock UTAs/VCs</button>
    </form>
    <table id="tabelaStock"><thead><tr><th>Data</th><th>Tipo</th><th>Produto</th><th>Qtd</th></tr></thead><tbody></tbody></table>
    <div id="totalStock" class="total"></div>
  </div>

  <!-- Filtros -->
   <div class="content" id="filtros">
    <h2>Filtros</h2>
    <form id="formFiltro">
      <label>Empresa:<input type="text" id="empresaFiltro"></label>
      <label>Edif√≠cio:<input type="text" id="edificioFiltro"></label>
      <label>Data:<input type="date" id="dataFiltro"></label>
      <button type="submit"style="background-color: green;">Aplicar</button>
      <button type="button" onclick="limparFiltros()"style="background-color: red;">Cancelar</button>
    </form>
    <table id="tabelaFiltro"><thead><tr><th>Empresa</th><th>Edif√≠cio</th><th>Tipo</th><th>Data</th><th>Obs</th></tr></thead><tbody></tbody></table>
    <div id="totalFiltro" class="total"></div>
  </div>

  <!-- Notas -->
  <div class="content" id="notas">
    <h2>Notas</h2>
    <input type="hidden" id="indiceEditarNota">
    <textarea id="textoNota" rows="4" cols="181" style="font-size: 18px;"></textarea><br>
    <button onclick="guardarNota()" style="background-color: green;">Guardar</button>
    <button onclick="resetFormNota()" style="background-color: red;">Cancelar</button>
    <button type="button" onclick="openLink2()">Tarefas</button>
    <button type="button" onclick="openLink3()">Planta</button>
    <table id="tabelaNotas"><thead><tr><th>Notas</th></tr></thead><tbody></tbody></table>
    <div id="totalNotas" class="total"></div>
  </div>

  <!-- Excel -->
  <div class="content" id="excel">
    <h2>Importar Excel</h2>
    <input type="file" id="inputExcel" accept=".xlsx,.xls" />
    <button onclick="importarExcel()" style="color: blue;">Importar do Excel</button>
  </div>
  <script>
  // --------- LOCAL STORAGE ---------
  function guardarLocal() {
    localStorage.setItem("manutencoes", JSON.stringify(manutencoes));
    localStorage.setItem("stock", JSON.stringify(stock));
    localStorage.setItem("notas", JSON.stringify(notas));
  }

  function carregarLocal() {
    manutencoes = JSON.parse(localStorage.getItem("manutencoes")) || [];
    stock = JSON.parse(localStorage.getItem("stock")) || [];
    notas = JSON.parse(localStorage.getItem("notas")) || [];

    renderNovo();
    renderStock();
    renderNota();
  }

    // --------- DADOS ---------
    let manutencoes = [], stock = [], notas = [];

    // --------- TABS ---------
    document.querySelectorAll(".tab").forEach(tab => {
      tab.addEventListener("click", () => {
        document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
        document.querySelectorAll(".content").forEach(c => c.classList.remove("active"));
        tab.classList.add("active");
        document.getElementById(tab.dataset.tab).classList.add("active");
      });
    });

    // --------- GUARDAR ---------
    document.getElementById("formNovo").addEventListener("submit", e => {
      e.preventDefault();
      const idx = indiceEditarNovo.value;
      const reg = { empresa: empresa.value, edificio: edificio.value, tipo: tipo.value, data: dataNovo.value, obs: obs.value };
      if (idx) manutencoes[idx] = reg; else manutencoes.push(reg);
      guardarLocal();renderNovo(); resetForm("formNovo");
    });

    document.getElementById("formStock").addEventListener("submit", e => {
      e.preventDefault();
      const idx = indiceEditarStock.value;
      const reg = { data: dataStock.value, tipo: tipoStock.value, produto: produto.value, quantidade: quantidade.value };
      if (idx) stock[idx] = reg; else stock.push(reg);
      guardarLocal();renderStock(); resetForm("formStock");
    });

    document.getElementById("formFiltro").addEventListener("submit", e => {
      e.preventDefault();
      aplicarFiltros();
    });

    
    function guardarNota() {
      const idx = indiceEditarNota.value;
      if (idx) notas[idx] = textoNota.value; else notas.push(textoNota.value);
      guardarLocal();renderNota(); resetFormNota();
    }

    // --------- RENDER ---------
    function renderNovo() {
      renderTabela("tabelaNovo", manutencoes, ["empresa","edificio","tipo","data","obs"], "totalNovo", "manutencoes", "formNovo");
    }
    function renderStock() {
      renderTabela("tabelaStock", stock, ["data","tipo","produto","quantidade"], "totalStock", "stock", "formStock");
    }

    function renderNota() {
      const dados = notas.map(n => ({Nota: n}));
      renderTabela("tabelaNotas", dados, ["Nota"], "totalNotas", "notas", "formNota");
    }

    function aplicarFiltros() {
      const empresaVal = empresaFiltro.value.trim().toLowerCase();
      const edificioVal = edificioFiltro.value.trim().toLowerCase();
      const dataVal = dataFiltro.value;

      // Filtra as manuten√ß√µes
      let resultados = manutencoes.filter(m => {
        return (!empresaVal || m.empresa.toLowerCase().includes(empresaVal)) &&
               (!edificioVal || m.edificio.toLowerCase().includes(edificioVal)) &&
               (!dataVal || m.data === dataVal);
      });

      renderTabela("tabelaFiltro", resultados, ["empresa","edificio","tipo","data","obs"], "totalFiltro", "manutencoes", "formFiltro");
    }


    function limparFiltros() {
      document.getElementById("formFiltro").reset();
      renderTabela("tabelaFiltro", manutencoes, ["empresa","edificio","tipo","data","obs"], "totalFiltro", "manutencoes", "formNovo");
    }

    function renderTabela(id, dados, campos, totalId, key, formId) {
      const tbody = document.querySelector(`#${id} tbody`);
      tbody.innerHTML = "";
      dados.forEach((item, i) => {
        const tr = document.createElement("tr");
        campos.forEach(c => {
          const td = document.createElement("td");
          td.textContent = item[c] ?? "";
          tr.appendChild(td);
        });
        tr.onclick = () => selecionarLinha(tr, key, i, document.getElementById(formId));
        tbody.appendChild(tr);
      });
      document.getElementById(totalId).textContent = "Total de registos: " + dados.length;
    }

    // --------- SELE√á√ÉO ---------
    function selecionarLinha(tr, key, index, form) {
      document.querySelectorAll("tr.selected").forEach(r => r.classList.remove("selected"));
      tr.classList.add("selected");

      let dados;
      if (key === "manutencoes") dados = manutencoes[index];
      if (key === "stock") dados = stock[index];
      if (key === "filtros") dados = filtros[index];
      if (key === "notas") dados = { Nota: notas[index] };

      if (!dados) return;

      if (key === "manutencoes") {
        empresa.value = dados.empresa; edificio.value = dados.edificio; tipo.value = dados.tipo;
        dataNovo.value = dados.data; obs.value = dados.obs; indiceEditarNovo.value = index;
      } else if (key === "stock") {
        dataStock.value = dados.data; tipoStock.value = dados.tipo; produto.value = dados.produto;
        quantidade.value = dados.quantidade; indiceEditarStock.value = index;
      } else if (key === "filtros") {
        empresaFiltro.value = dados.empresa; edificioFiltro.value = dados.edificio;
        dataFiltro.value = dados.data; indiceEditarFiltro.value = index;
      } else if (key === "notas") {
        textoNota.value = dados.Nota; indiceEditarNota.value = index;
      }

      tr.ondblclick = () => {
        if (confirm("Apagar este registo?")) {
          if (key === "manutencoes") { manutencoes.splice(index,1); renderNovo(); }
          if (key === "stock") { stock.splice(index,1); renderStock(); }
          if (key === "filtros") { filtros.splice(index,1); renderFiltro(); }
          if (key === "notas") { notas.splice(index,1); renderNota(); }
          resetForm(form.id);
        }
      };
    }

    // --------- RESET ---------
    function resetForm(id) { document.getElementById(id).reset(); document.querySelector(`#${id} input[type=hidden]`).value = ""; }
    function resetFormNota() { textoNota.value = ""; indiceEditarNota.value = ""; }

    // --------- EXPORTAR ---------
    function exportarExcel() {
      const wb = XLSX.utils.book_new();
      if (manutencoes.length) XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(manutencoes), "Manutencoes");
      if (stock.length) XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(stock), "Stock");
      if (filtros.length) XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(filtros), "Filtros");
      if (notas.length) XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(notas.map(n => ({Nota: n}))), "Notas");
      XLSX.writeFile(wb, "registoManutencoes.xlsx");
    }

    // --------- IMPORTAR ---------
    function importarExcel() {
      const file = document.getElementById("inputExcel").files[0];
      if (!file) { alert("Escolha um ficheiro Excel."); return; }
      const reader = new FileReader();
      reader.onload = e => {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: "array" });
        if (workbook.Sheets["Manutencoes"]) { manutencoes = XLSX.utils.sheet_to_json(workbook.Sheets["Manutencoes"]); renderNovo(); }
        if (workbook.Sheets["Stock"]) { stock = XLSX.utils.sheet_to_json(workbook.Sheets["Stock"]); renderStock(); }
        if (workbook.Sheets["Filtros"]) { filtros = XLSX.utils.sheet_to_json(workbook.Sheets["Filtros"]); renderFiltro(); }
        if (workbook.Sheets["Notas"]) { const rows = XLSX.utils.sheet_to_json(workbook.Sheets["Notas"]); notas = rows.map(r => r.Nota); renderNota(); }
        alert("Dados importados!");
      };
      reader.readAsArrayBuffer(file);
    }

    function abrirLink() {
      // coloca aqui o link da Manuten√ß√£o Preventiva
      const url = "https://uminho365-my.sharepoint.com/:x:/r/personal/f14491_uminho_pt/Documents/Manuten%C3%A7%C3%A3o_Preventiva.xlsx?d=w92cf980bf7e24f069ac9e6afd86ead26&csf=1&web=1&e=E9xln0";
      window.open(url, "_blank"); // abre numa nova aba
    }

    function abrirLink2() {
      // coloca aqui o link das Impressoras
      const url = "https://uminho365-my.sharepoint.com/:x:/r/personal/f14491_uminho_pt/_layouts/15/Doc.aspx?sourcedoc=%7B1371FA4C-2ED3-4EF2-A040-28CDF1332D38%7D&file=Impressoras.xlsx&action=default&mobileredirect=true";
      window.open(url, "_blank"); // abre numa nova aba
    }

    function abrirLink3() {
      // coloca aqui o link das Leituras
      const url = "https://uminho365-my.sharepoint.com/:x:/r/personal/f14491_uminho_pt/_layouts/15/Doc.aspx?sourcedoc=%7BAD995DF2-214B-4466-BA17-669A2082AC93%7D&file=Leituras.xlsx&action=default&mobileredirect=true&DefaultItemOpen=1";
      window.open(url, "_blank"); // abre numa nova aba
    }

    function openLink() {
      // coloca aqui o link do Controle de Stocks
      const url = "https://uminho365-my.sharepoint.com/:x:/r/personal/f14491_uminho_pt/Documents/Controle-de-Stock_UTAs.xlsx?d=w18cbcab82d9b41fb94ea1b89373a48f8&csf=1&web=1&e=eS5XJG";
      window.open(url, "_blank"); // abre numa nova aba
    }

    function openLink2() {
      // coloca aqui o link das Tarefas
      const url = "https://uminho365-my.sharepoint.com/:x:/r/personal/f14491_uminho_pt/_layouts/15/Doc.aspx?sourcedoc=%7BC7742C00-AF9F-4A16-8659-74BEF5A4063C%7D&file=Lista_de_Pendentes.xlsx&action=default&mobileredirect=true";
      window.open(url, "_blank"); // abre numa nova aba
    }

    function openLink3() {
      // coloca aqui o link da Planta
      const url = "https://uminho365-my.sharepoint.com/my?viewid=8d5fabc0%2D2c0b%2D4ca0%2D9de0%2D81323a91323a&CT=1747040050901&OR=OWA%2DNT%2DMail&e=5%3A67e88637854b44048575e7a6a30d48c3&sharingv2=true&fromShare=true&at=9&FolderCTID=0x01200065B8B3FF27D6AB49A2FD2D662C8E3545&id=%2Fpersonal%2Ff14491%5Fuminho%5Fpt%2FDocuments%2FPlantaAR%2Epdf&parent=%2Fpersonal%2Ff14491%5Fuminho%5Fpt%2FDocuments";
      window.open(url, "_blank"); // abre numa nova aba
    }
  // Carregar dados locais ao iniciar
  carregarLocal();

  // --------- ALERTA AO FECHAR JANELA ---------
  window.addEventListener("beforeunload", function (e) {
    const mensagem = "Tem dados n√£o exportados.\nDeseja exportar para Excel antes de sair?";
    e.preventDefault();
    e.returnValue = mensagem; // obrigat√≥rio para o browser mostrar o alerta
    return mensagem;
});

  </script>
</body>
<footer style="text-align: right; margin-top: 10px; font-size: 24px; font-family: Brush Script MT; color: blue;">Rui Baptista</footer>
<footer style="text-align: right; margin-top: 10px; font-size: 24px; font-family: Brush Script MT; color: red;">2025</footer>
</html>
